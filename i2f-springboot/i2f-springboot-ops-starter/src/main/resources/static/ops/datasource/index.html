<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ops - Datasource</title>
  <script src="../lib/vue/vue-2.js"></script>
  <script src="../lib/moment/moment-2.24.0.js"></script>
  <script src="../lib/element-ui/element-ui-2.15.10.js"></script>
  <link rel="stylesheet" href="../lib/element-ui/element-ui-2.15.10.css"/>
  <link rel="stylesheet" href="../lib/element-ui/element-ui-2.15.10-icon.css"/>
  <link href="../lib/element-ui/fonts/element-icons.ttf"/>
  <link href="../lib/element-ui/fonts/element-icons.woff"/>
  <script src="../lib/axios/axios-1.1.3.min.js"></script>
  <script src="../lib/axios/qs.js"></script>
  <script src="../lib/sm-crypto-0.3.2.1-RELEASE/sm4.js"></script>
  <script src="../lib/sm-crypto-0.3.2.1-RELEASE/sm3.js"></script>
  <script src="../lib/sm-crypto-0.3.2.1-RELEASE/sm2.js"></script>
  <script src="../lib/base64/Base64.js"></script>
  <script src="../common/OpsSecureKeyPair.js"></script>
  <script src="../common/OpsSecureCertPair.js"></script>
  <script src="../common/OpsSecureDto.js"></script>
  <script src="../common/OpsSecureHelper.js"></script>
  <script src="../common/OpsSecureTransfer.js"></script>
  <script src="../lib/echarts-5/echarts.min.js"></script>
</head>
<body>
<div id="app">
  <el-divider>连接证书</el-divider>
  <el-input
          type="textarea"
          :rows="3"
          placeholder="请输入连接证书"
          v-model="metas.cert"
          @change="onCertChange">
  </el-input>
  <el-divider>SQL操作</el-divider>
  <el-input ref="refInputSql"
          type="textarea"
          :rows="10"
          placeholder="请输入SQL"
          v-model="form.sql"
            @change="onSqlChange">
  </el-input>
  <el-row>
    <el-form inline label-position="left" label-width="80px">
      <el-row>
        <el-checkbox v-model="form.useCustomDatasource">自定义数据源</el-checkbox>
        <template v-if="form.useCustomDatasource">
          <el-form-item label="驱动">
            <el-select v-model="form.driver" placeholder="驱动">
              <el-option
                      v-for="item in metas.driverList"
                      :key="item"
                      :label="item"
                      :value="item">
              </el-option>
            </el-select>
            <el-button type="primary" @click="doRefreshDrivers">刷新</el-button>
          </el-form-item>
          <el-form-item label="JDBC URL">
            <el-input v-model="form.url" placeholder="jdbc:mysql://localhost:3306"></el-input>
          </el-form-item>
          <el-form-item label="用户名">
            <el-input v-model="form.username" placeholder="root"></el-input>
          </el-form-item>
          <el-form-item label="密码">
            <el-input v-model="form.password" placeholder="123456"></el-input>
          </el-form-item>
        </template>
        <template v-else>
          <el-form-item label="数据源">
            <el-select v-model="form.datasource" placeholder="数据源">
              <el-option
                      v-for="item in metas.datasourceList"
                      :key="item"
                      :label="item"
                      :value="item">
              </el-option>
            </el-select>
            <el-button type="primary" @click="doRefreshDatasources">刷新</el-button>
          </el-form-item>
        </template>
      </el-row>
      <el-row type="flex">
        <el-col :span="16">
          <el-row>
            <el-form-item label="执行类型">
              <el-select v-model="metas.operate" placeholder="执行类型">
                <el-option
                        v-for="item in metas.operateList"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                </el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="结果数">
              <el-input-number v-model="form.maxCount" :min="-1"></el-input-number>
            </el-form-item>
            <el-form-item>
              <el-button type="primary" @click="onExecute">执行</el-button>
              <el-button type="warning" @click="onExecuteScript">执行脚本</el-button>
            </el-form-item>
          </el-row>
        </el-col>
        <el-col :span="8">
          <el-row type="flex" justify="end">
            <el-form-item>
              <el-button type="success" @click="onViewMetadata">元数据</el-button>
            </el-form-item>
          </el-row>
        </el-col>
      </el-row>

    </el-form>
  </el-row>
  <el-divider>操作结果</el-divider>
  <el-select v-model="metas.resultType" placeholder="结果类型">
    <el-option
            v-for="item in metas.resultTypeList"
            :key="item.value"
            :label="item.label"
            :value="item.value">
    </el-option>
  </el-select>
  <el-button type="success" @click="onViewText(metas.resultList,'数据集')">表格JSON</el-button>
  <el-button type="warning" @click="onViewText(metas.resultColumns,'表头信息')">表头JSON</el-button>
  <el-button type="primary" @click="onVisualCharts">可视化图表</el-button>
  <el-row v-show="metas.resultType=='table'">
    <el-table border stripe highlight-current-row
              :data="metas.resultList"
              style="width: 100%">
      <el-table-column show-overflow-tooltip
                       label="操作">
        <template slot-scope="scope">
          <el-tag type="success" @click="onViewText(scope.row,'数据行')">显示JSON</el-tag>
        </template>
      </el-table-column>
      <template v-for="column in metas.resultColumns">
        <el-table-column show-overflow-tooltip
                :prop="column.label"
                :label="column.label">
          <template slot-scope="scope">
            {{scope.row[column.label]}}
          </template>
        </el-table-column>
      </template>

    </el-table>
  </el-row>
  <el-row v-show="metas.resultType=='text'">
    <el-input
            type="textarea"
            :rows="8"
            placeholder="执行结果"
            v-model="metas.resultText">
    </el-input>
  </el-row>
  <el-drawer
          title="元数据"
          :visible.sync="drawer.metadata.show"
          direction="rtl"
          size="75%">
    <el-row type="flex">
      <el-col :span="8" style="border-right: solid 1px #777;">
        <el-row style="width: 100%;">
          <el-row type="flex">
            <el-col :span="12">
              <el-row>
                数据库
              </el-row>
            </el-col>
            <el-col :span="12">
              <el-row type="flex" justify="end">
                <el-button type="success" @click="onViewText(drawer.metadata.databases,'数据库列表')">数据库JSON
                </el-button>
                <el-button type="primary" @click="onRefreshDatabases">刷新</el-button>
              </el-row>
            </el-col>


          </el-row>
          <el-row>
            <el-input v-model="drawer.metadata.checkDatabase" placeholder="选中数据库"></el-input>
          </el-row>
          <el-row v-for="(item,index) in drawer.metadata.databases"
                  :class="'list-item '+(item==drawer.metadata.checkDatabase?'checked-item':'')"
                  @click.native="onClickDatabaseItem(item)">
            {{item}}
          </el-row>
        </el-row>
      </el-col>
      <el-col :span="16">
        <el-row style="width: 100%;">
          <el-row type="flex">
            <el-col :span="12">
              <el-row>
                表
              </el-row>
            </el-col>
            <el-col :span="12">
              <el-row type="flex" justify="end">
                <el-button type="success" @click="onViewText(drawer.metadata.tables,'表列表')">表JSON</el-button>
                <el-button type="primary" @click="onRefreshTables">刷新</el-button>
              </el-row>
            </el-col>
          </el-row>
          <el-row>
            <el-input v-model="drawer.metadata.checkTable" placeholder="选中表">
              <el-button slot="append" icon="el-icon-search"></el-button>
            </el-input>
          </el-row>
          <el-row type="flex"
                  v-for="(item,index) in drawer.metadata.tables"
                  :class="'list-item '+(item.name==drawer.metadata.checkTable?'checked-item':'')"
                  @click.native="onClickTableItem(item)">
            <el-col :span="12"  style="border-right: solid 1px #777;">
              <el-tag type="primary" @click="onViewTableInfo(item)">结构</el-tag>
              {{item.name}}
            </el-col>
            <el-col :span="12">
              {{item.comment}}
            </el-col>
          </el-row>
        </el-row>
      </el-col>
    </el-row>
  </el-drawer>
  <el-dialog
          :title="dialog.tableInfo.title"
          :visible.sync="dialog.tableInfo.show"
          width="75%">
    <el-row>
      表名：{{dialog.tableInfo.meta.name}}
    </el-row>
    <el-row>
      注释：{{dialog.tableInfo.meta.comment}}
    </el-row>
    <el-row>
      <el-button type="primary" @click="doLoadTableInfo">刷新</el-button>
      <el-button type="success" @click="onViewText(dialog.tableInfo.meta,'表结构')">表结构JSON</el-button>
    </el-row>
    <el-row>
      <el-table border stripe
              :data="dialog.tableInfo.meta.columns"
              style="width: 100%">
        <el-table-column
                label="操作">
          <template slot-scope="scope">
            <el-tag type="success" @click="onViewText(scope.row,'列信息')">显示JSON</el-tag>
          </template>
        </el-table-column>
        <el-table-column
                prop="index"
                label="序号">
        </el-table-column>
        <el-table-column
                prop="name"
                label="列名">
        </el-table-column>
        <el-table-column
                prop="columnType"
                label="类型">
        </el-table-column>
        <el-table-column
                prop="primaryKey"
                label="主键">
          <template slot-scope="scope">
            {{scope.row.primaryKey?'是':''}}
          </template>
        </el-table-column>
        <el-table-column
                prop="uniqueKey"
                label="唯一">
          <template slot-scope="scope">
            {{scope.row.uniqueKey?'是':''}}
          </template>
        </el-table-column>
        <el-table-column
                prop="nullable"
                label="非空">
          <template slot-scope="scope">
            {{scope.row.nullable?'':'是'}}
          </template>
        </el-table-column>
        <el-table-column
                prop="comment"
                label="注释">
        </el-table-column>
      </el-table>
    </el-row>

    <el-row style="margin-top: 3px;border-bottom: solid 1px #777;">
      主键：
      <el-row v-if="dialog.tableInfo.meta.primary">
        <el-row>
          键名：{{dialog.tableInfo.meta.primary.name}}
        </el-row>
        <el-row>
          列：
          <template v-for="(item,index) in dialog.tableInfo.meta.primary.columns">
            {{index>0?',':''}} {{item.name}} {{item.desc?'desc':'asc'}}
          </template>
        </el-row>
      </el-row>
    </el-row>


    <el-row style="margin-top: 3px;border-bottom: solid 1px #777;">
      唯一索引：
      <el-row v-if="dialog.tableInfo.meta.uniqueIndexes">
        <el-row v-for="tableIndex in dialog.tableInfo.meta.uniqueIndexes">
          <el-row>
            键名：{{tableIndex.name}}
          </el-row>
          <el-row>
            列：
            <template v-for="(item,index) in tableIndex.columns">
              {{index>0?',':''}} {{item.name}} {{item.desc?'desc':'asc'}}
            </template>
          </el-row>
        </el-row>
      </el-row>
    </el-row>

    <el-row style="margin-top: 3px;border-bottom: solid 1px #777;">
      普通索引：
      <el-row v-if="dialog.tableInfo.meta.indexes">
        <el-row v-for="tableIndex in dialog.tableInfo.meta.indexes">
          <el-row>
            键名：{{tableIndex.name}}
          </el-row>
          <el-row>
            列：
            <template v-for="(item,index) in tableIndex.columns">
              {{index>0?',':''}} {{item.name}} {{item.desc?'desc':'asc'}}
            </template>
          </el-row>
        </el-row>
      </el-row>
    </el-row>

    <el-row>
      DDL:
      <el-button type="primary" @click="onLoadTableDdl">加载DDL</el-button>
      <el-select v-model="dialog.tableInfo.ddlType" placeholder="DDL方言">
        <el-option
                v-for="item in metas.ddlTypeList"
                :key="item.value"
                :label="item.label"
                :value="item.value">
        </el-option>
      </el-select>
      <el-input
              type="textarea"
              :rows="10"
              placeholder="DDL"
              v-model="dialog.tableInfo.tableDdl">
      </el-input>
    </el-row>

  </el-dialog>

  <el-dialog
          :title="dialog.textViewer.title"
          :visible.sync="dialog.textViewer.show"
          width="60%">
      <el-input
              type="textarea"
              :rows="15"
              placeholder="文本浏览"
              v-model="dialog.textViewer.text">
      </el-input>
    </el-dialog>

  <el-dialog
          :title="dialog.scriptRunner.title"
          :visible.sync="dialog.scriptRunner.show"
          width="60%">
    <el-row>
      <el-form :inline="true" label-width="80px">
        <el-form-item>
          <el-popover
                  placement="top-start"
                  width="200"
                  trigger="hover"
                  content="不开启自动提交就是以事务方式运行">
            <el-checkbox slot="reference" v-model="dialog.scriptRunner.autoCommit">自动提交</el-checkbox>
          </el-popover>

        </el-form-item>
        <el-form-item>
          <el-popover
                  placement="top-start"
                  width="200"
                  trigger="hover"
                  content="是否让驱动完整发送整个脚本给数据库执行，在对代码段、函数、过程等编译时常常有用">
            <el-checkbox slot="reference" v-model="dialog.scriptRunner.sendFullScript">完整发送</el-checkbox>
          </el-popover>

        </el-form-item>
        <el-form-item>
          <el-popover
                  placement="top-start"
                  width="200"
                  trigger="hover"
                  content="在执行过程中，发生错误之后是否停止往下继续执行">
            <el-checkbox slot="reference" v-model="dialog.scriptRunner.stopOnError">错误停止</el-checkbox>
          </el-popover>

        </el-form-item>
        <el-form-item label="分隔符">
          <el-input
                  placeholder="分隔符"
                  v-model="dialog.scriptRunner.delimiter">
          </el-input>
        </el-form-item>
      </el-form>
    </el-row>
    <el-row type="flex" justify="end">
      <el-button type="primary" @click="doExecuteScript">执行</el-button>
      <el-button @click="dialog.scriptRunner.show=false">取消</el-button>
    </el-row>

  </el-dialog>

  <el-dialog
          :title="dialog.visualChart.title"
          :visible.sync="dialog.visualChart.show"
          width="60%">
    <el-form :inline="true">
      <el-form-item label="X轴">
        <el-select v-model="dialog.visualChart.config.xAxis" placeholder="X轴">
          <el-option
                  v-for="item in metas.resultColumns"
                  :key="item.label"
                  :label="item.label"
                  :value="item.label">
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="Y轴">
        <el-select v-model="dialog.visualChart.config.yAxisList" multiple  placeholder="Y轴">
          <el-option
                  v-for="item in metas.resultColumns"
                  :key="item.label"
                  :label="item.label"
                  :value="item.label">
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="doRenderEcharts">绘制图表</el-button>
      </el-form-item>
    </el-form>

    <div ref="refEchartDom" style="height: 480px;width:100%;"></div>
  </el-dialog>
</div>
</body>
<script>

  window.app = new Vue({
    data() {
      return {
        metas:{
          cert: '',
          datasourceList: [],
          operate: 'query',
          operateList:[
            {
              label: '查询',
              value: 'query'
            },{
              label: '更新',
              value: 'update'
            }
          ],
          resultType: 'table',
          resultTypeList:[
            {
              label: '表格',
              value: 'table'
            },{
              label: '文本',
              value: 'text'
            }
          ],
          resultText: '',
          resultColumns:[],
          resultList:[],
          ddlTypeList:[
            {
              label: 'Auto',
              value: 'auto',
            }, {
              label: 'Oracle',
              value: 'oracle',
            },{
              label: 'MySQL',
              value: 'mysql',
            },{
              label: 'PostgreSQL',
              value: 'postgre',
            },{
              label: 'Gbase',
              value: 'gbase',
            }
          ]
        },
        drawer:{
          metadata:{
            show:  false,
            checkDatabase: '',
            databases:[],
            checkTable: '',
            tables:[],
          }
        },
        dialog:{
          tableInfo:{
            show: false,
            title: '表结构',
            meta:{},
            ddlType: 'auto',
            tableDdl: '',
          },
          textViewer:{
            show: false,
            title: '文本浏览',
            text: ''
          },
          scriptRunner: {
            show: false,
            title: '执行脚本',
            autoCommit: false,
            delimiter: ';',
            sendFullScript: false,
            stopOnError: true
          },
          visualChart:{
            show: false,
            title: '可视化图表',
            config: {
              xAxis: null,
              yAxisList:[]
            }
          }
        },
        form:{
          datasource: '',
          useCustomDatasource: false,
          driver: '',
          url: '',
          username: '',
          password: '',
          sql: '',
          selectSql: '',
          maxCount: 300
        }
      }
    },
    created() {

    },
    methods: {
      getTransfer(){
        debugger
        let certPair = OpsSecureHelper.generateCertPair();
        let serverTransfer=new OpsSecureTransfer(OpsSecureHelper.deserializeKeyPair(certPair.serverCert))
        let dto = serverTransfer.send('1234');
        let clientTransfer=new OpsSecureTransfer(OpsSecureHelper.deserializeKeyPair(certPair.clientCert))
        let resp = clientTransfer.recv(dto);
        let cert=this.metas.cert;
        if(!cert || cert.length==0){
          cert='';
        }
        cert=cert.trim();
        if (!cert || cert.length == 0) {
          this.$message.error('请先填写连接证书')
        }
        let keyPair=OpsSecureHelper.deserializeKeyPair(cert)
        return new OpsSecureTransfer(keyPair)
      },
      onCertChange(){
        this.doRefreshDatasources()
        this.doRefreshDrivers()
      },
      doRefreshDatasources(){
        let timestamp=new Date().getTime();
        let transfer = this.getTransfer();
        this.$axios({
          url: '/datasources',
          method: 'post',
          data: transfer.send(timestamp)
        }).then(res=>{
          if(res.data.code==200){
            console.log(res.data)
            let resp=transfer.recv(res.data.data)
            console.log(resp)
            this.metas.datasourceList=resp.list;
            this.form.datasource=resp.defaultName;
          }else{
            this.$message.error(res.data.msg)
          }
        }).catch(err=>{
          this.$message.error(err.errorMessage||'操作失败')
        })
      },
      doRefreshDrivers() {
        let timestamp = new Date().getTime();
        let transfer = this.getTransfer();
        this.$axios({
          url: '/drivers',
          method: 'post',
          data: transfer.send(timestamp)
        }).then(res => {
          if (res.data.code == 200) {
            console.log(res.data)
            let resp = transfer.recv(res.data.data)
            console.log(resp)
            this.metas.driverList = resp;
            if (resp.length > 0 && this.form.driver == '') {
              this.form.driver = resp[0];
            }
          } else {
            this.$message.error(res.data.msg)
          }
        }).catch(err => {
          this.$message.error(err.errorMessage || '操作失败')
        })
      },
      fillDatasourceForm(req) {
        req.useCustomDatasource = this.form.useCustomDatasource;
        if (req.useCustomDatasource) {
          req.useCustomDatasource = this.form.useCustomDatasource;
          req.driver = this.form.driver;
          req.url = this.form.url;
          req.username = this.form.username;
          req.password = this.form.password;
        } else {
          req.datasource = this.form.datasource;
        }
        return req;
      },
      onSqlChange() {
        let sql=this.form.sql;
        if(!sql){
          return;
        }
        sql=sql.trim();
        let arr = sql.split(/\s+/,2);
        let key=arr[0].toLowerCase();
        if(['select','with'].some(e=>e==key)){
          this.metas.operate='query'
        }else{
          this.metas.operate='update'
        }
      },
      onExecute(){
        debugger
        let sql=this.form.sql;

        let req = this.fillDatasourceForm({
          sql: sql,
          maxCount: this.form.maxCount,
        });
        let operate=this.metas.operate;
        let transfer = this.getTransfer();
        this.$axios({
          url: `/${operate}`,
          method: 'post',
          data: transfer.send(req)
        }).then(res=>{
          if(res.data.code==200){
            console.log(res.data)
            let resp=transfer.recv(res.data.data)
            console.log(resp)
            if(operate=='update' && !resp.columns){
              this.metas.resultText=resp+'';
              this.metas.resultType='text';
            }else{
              this.metas.resultList=resp.rows;
              this.metas.resultColumns=resp.columns;
              this.metas.resultType='table';
            }
          }else{
            this.$message.error(res.data.msg)
          }
        }).catch(err=>{
          this.$message.error(err.errorMessage||'操作失败')
        })
      },
      onExecuteScript() {
        this.dialog.scriptRunner.show = true;
      },
      doExecuteScript() {
        debugger
        let sql = this.form.sql;

        let req = this.fillDatasourceForm({
          sql: sql,
          autoCommit: this.dialog.scriptRunner.autoCommit,
          delimiter: this.dialog.scriptRunner.delimiter,
          sendFullScript: this.dialog.scriptRunner.sendFullScript,
          stopOnError: this.dialog.scriptRunner.stopOnError,
        });
        let transfer = this.getTransfer();
        this.$axios({
          url: `/runner`,
          method: 'post',
          data: transfer.send(req)
        }).then(res => {
          if (res.data.code == 200) {
            console.log(res.data)
            let resp = transfer.recv(res.data.data)
            console.log(resp)
            this.metas.resultText = resp + '';
            this.metas.resultType = 'text';
          } else {
            this.$message.error(res.data.msg)
          }
        }).catch(err => {
          this.$message.error(err.errorMessage || '操作失败')
        })
      },
      onViewMetadata(){
        this.drawer.metadata.show=true
      },
      onRefreshDatabases(){
        let req = this.fillDatasourceForm({});
        let transfer = this.getTransfer();
        this.$axios({
          url: '/metadata/databases',
          method: 'post',
          data: transfer.send(req)
        }).then(res=>{
          if(res.data.code==200){
            console.log(res.data)
            let resp=transfer.recv(res.data.data)
            console.log(resp)
            this.drawer.metadata.databases=resp.list;
            this.drawer.metadata.checkDatabase=resp.defaultName;
          }else{
            this.$message.error(res.data.msg)
          }
        }).catch(err=>{
          this.$message.error(err.errorMessage||'操作失败')
        })
      },
      onClickDatabaseItem(database){
        this.drawer.metadata.checkDatabase=database;
      },
      onRefreshTables(){
        let req = this.fillDatasourceForm({
          database: this.drawer.metadata.checkDatabase,
        });
        let transfer = this.getTransfer();
        this.$axios({
          url: '/metadata/tables',
          method: 'post',
          data: transfer.send(req)
        }).then(res=>{
          if(res.data.code==200) {
            console.log(res.data)
            let resp = transfer.recv(res.data.data)
            console.log(resp)
            this.drawer.metadata.tables = resp;
          }else{
            this.$message.error(res.data.msg)
          }
        }).catch(err=>{
          this.$message.error(err.errorMessage||'操作失败')
        })
      },
      onClickTableItem(item){
        this.drawer.metadata.checkTable=item.name;
      },
      onViewTableInfo(item){
        this.drawer.metadata.checkTable=item.name;
        this.dialog.tableInfo.show=true;
        if(this.dialog.tableInfo.meta && this.dialog.tableInfo.meta.name==item.name){
          return;
        }
        this.doLoadTableInfo()
      },
      doLoadTableInfo(){
        let req = this.fillDatasourceForm({
          database: this.drawer.metadata.checkDatabase,
          table: this.drawer.metadata.checkTable
        });
        let transfer = this.getTransfer();
        this.$axios({
          url: '/metadata/table/info',
          method: 'post',
          data: transfer.send(req)
        }).then(res=>{
          if(res.data.code==200){
            console.log(res.data)
            let resp=transfer.recv(res.data.data)
            console.log(resp)
            this.dialog.tableInfo.meta=resp;
            this.dialog.tableInfo.title=resp.name;
          }else{
            this.$message.error(res.data.msg)
          }
        }).catch(err=>{
          this.$message.error(err.errorMessage||'操作失败')
        })
      },
      onLoadTableDdl(){
        let req = this.fillDatasourceForm({
          database: this.drawer.metadata.checkDatabase,
          table: this.drawer.metadata.checkTable,
          ddlType: this.dialog.tableInfo.ddlType
        });
        let transfer = this.getTransfer();
        this.$axios({
          url: '/metadata/table/ddl',
          method: 'post',
          data: transfer.send(req)
        }).then(res=>{
          if(res.data.code==200){
            console.log(res.data)
            let resp=transfer.recv(res.data.data)
            console.log(resp)
            this.dialog.tableInfo.tableDdl=resp;
          }else{
            this.$message.error(res.data.msg)
          }
        }).catch(err=>{
          this.$message.error(err.errorMessage||'操作失败')
        })
      },
      onViewText(obj,title){
        if(title && title.length>0){
          this.dialog.textViewer.title=title;
        }else{
          this.dialog.textViewer.title='文本浏览';
        }
        let text=''
        if(typeof obj=='string'){
          text=obj;
        }else{
          text=JSON.stringify(obj,null,'    ');
        }
        this.dialog.textViewer.text=text;
        this.dialog.textViewer.show=true;
      },
      onVisualCharts(){
        this.dialog.visualChart.show=true;
      },
      doRenderEcharts(){
        let option=this.convertAsEChartsOptions(this.metas.resultList,this.dialog.visualChart.config);
        let dom = this.$refs.refEchartDom.$el;
        let myChart = echarts.init(dom, null, {
          renderer: 'canvas',
          useDirtyRect: false
        });
        if (option && typeof option === 'object') {
          myChart.setOption(option);
        }
        window.addEventListener('resize', myChart.resize);
      },
      convertAsEChartsOptions(dataList,config){
        if(!dataList){
          dataList=[];
        }
        if(!config){
          config={
            xAxis: 'label',
            yAxisList:['value']
          };
        }
        let xAxisList=[];
        let seriasMap={};
        dataList.forEach(item=>{

          xAxisList.push(item[config.xAxis])

          for(let i=0;i<config.yAxisList.length;i++){
            let prop=config.yAxisList[i];
            if(!seriasMap[prop]){
              seriasMap[prop]={
                name: prop,
                type: 'line',
                data:[]
              }
            }
            seriasMap[prop].data.push(item[prop])
          }


        })

        let serias=[]
        let legendList=[]
        Object.keys(seriasMap).forEach(k=>{
          serias.push(seriasMap[k])
          legendList.push(k)
        })


        let option = {
          title: {
            text: 'Visual Line'
          },
          tooltip: {
            trigger: 'axis'
          },
          legend: {
            data: legendList
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
          },
          toolbox: {
            feature: {
              saveAsImage: {}
            }
          },
          xAxis: {
            type: 'category',
            boundaryGap: false,
            data: xAxisList
          },
          yAxis: {
            type: 'value'
          },
          series: serias
        };
        return option;
      }
    }
  })
  let defaultConfig={
    baseURL: './',
    timeout: 10*60*1000,
    responseType: 'json'
  }
  let request = axios.create(defaultConfig)
  window.app.$axios=request
  window.app.$mount('#app')
</script>
<style>
  .list-item{
    margin-top: 3px;
    border-bottom: solid 1px    #777;
  }
  .list-item:hover{
    background: lightskyblue;
  }
  .checked-item{
    background: darkorange;
  }
</style>
</html>