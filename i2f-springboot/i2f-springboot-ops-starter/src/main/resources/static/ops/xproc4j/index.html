<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- 1小时缓存过期 -->
    <meta http-equiv="Cache-Control" content="max-age=3600, public">
    <title>Ops - XProc4J</title>
    <script src="../lib/vue/vue-2.js"></script>
    <script src="../lib/moment/moment-2.24.0.js"></script>
    <script src="../lib/element-ui/element-ui-2.15.10.js"></script>
    <link rel="stylesheet" href="../lib/element-ui/element-ui-2.15.10.css"/>
    <link rel="stylesheet" href="../lib/element-ui/element-ui-2.15.10-icon.css"/>
    <link href="../lib/element-ui/fonts/element-icons.ttf"/>
    <link href="../lib/element-ui/fonts/element-icons.woff"/>
    <script src="../lib/axios/axios-1.1.3.min.js"></script>
    <script src="../lib/axios/qs.js"></script>
    <script src="../lib/sm-crypto-0.3.2.1-RELEASE/sm4.js"></script>
    <script src="../lib/sm-crypto-0.3.2.1-RELEASE/sm3.js"></script>
    <script src="../lib/sm-crypto-0.3.2.1-RELEASE/sm2.js"></script>
    <script src="../lib/base64/Base64.js"></script>
    <script src="../common/OpsSecureKeyPair.js"></script>
    <script src="../common/OpsSecureCertPair.js"></script>
    <script src="../common/OpsSecureDto.js"></script>
    <script src="../common/OpsSecureHelper.js"></script>
    <script src="../common/OpsSecureTransfer.js"></script>
    <script src="../lib/echarts-5/echarts.min.js"></script>
    <!-- 从这里查找 CDN 资源： https://cdnjs.com/libraries/codemirror -->
    <script src="../lib/codemirror-6.65.7/codemirror.min.js"></script>
    <link rel="stylesheet" href="../lib/codemirror-6.65.7/codemirror.min.css"/>
    <link rel="stylesheet" href="../lib/codemirror-6.65.7/addon/hint/show-hint.min.css"/>
    <script src="../lib/codemirror-6.65.7/addon/hint/show-hint.min.js"></script>
    <link rel="stylesheet" href="../lib/codemirror-6.65.7/theme/idea.min.css"/>

    <script src="../lib/codemirror-6.65.7/addon/search/search.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/search/searchcursor.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/search/jump-to-line.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/search/match-highlighter.min.js" ></script>

    <link rel="stylesheet" href="../lib/vue-virtual-scroller/vue-virtual-scroller.css"/>
    <script src="../lib/vue-virtual-scroller/vue-virtual-scroller.min.js"></script>


    <script src="../lib/codemirror-6.65.7/mode/yaml/yaml.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/lint/yaml/yaml-lint.min.js" ></script>

    <script src="../lib/codemirror-6.65.7/mode/javascript/javascript.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/hint/javascript/javascript-hint.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/lint/javascript/javascript-lint.min.js" ></script>

    <script src="../lib/codemirror-6.65.7/mode/sql/sql.min.js"></script>
    <script src="../lib/codemirror-6.65.7/addon/hint/sql/sql-hint.min.js" ></script>

    <script src="../lib/codemirror-6.65.7/mode/shell/shell.min.js"></script>

    <script src="../lib/codemirror-6.65.7/mode/xml/xml.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/fold/xml/xml-fold.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/hint/xml/xml-hint.min.js" ></script>

    <script src="../lib/codemirror-6.65.7/addon/lint/html/html-lint.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/hint/html/html-hint.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/mode/htmlmixed/htmlmixed.min.js" ></script>

    <script src="../lib/codemirror-6.65.7/mode/markdown/markdown.min.js" ></script>
    <script src="../lib/codemirror-6.65.7/addon/fold/markdown/markdown-fold.min.js"></script>

    <script src="../lib/codemirror-6.65.7/mode/groovy/groovy.min.js" ></script>

    <script src="../lib/codemirror-6.65.7/mode/nginx/nginx.min.js" ></script>

    <script src="../lib/codemirror-6.65.7/mode/python/python.min.js" ></script>
</head>
<body>
<div id="app">
    <el-row class="cert-block">
        <el-divider>连接证书<i class="el-icon-d-caret"></i></el-divider>
        <el-input clearable
                type="textarea"
                :rows="3"
                placeholder="请输入连接证书"
                v-model="metas.cert"
                @change="onCertChange">
        </el-input>
    </el-row>

    <el-divider>XProc4J 操作</el-divider>
    <el-card shadow="never">
        <el-row type="flex">
            <el-col :span="16">
                <el-card v-show="!form.enableEvalScript" shadow="never">
                    <el-row type="flex">
                        <el-col :span="12">
                            <el-row>
                                <el-switch
                                        v-model="form.enableEvalScript"
                                        @change="onEvalLangChange"
                                        active-text="脚本"
                                        inactive-text="过程">
                                </el-switch>
                            </el-row>
                        </el-col>
                        <el-col :span="12">
                            <el-row type="flex" justify="end">
                                <el-button v-loading="metas.metasLoading" size="medium"
                                           icon="el-icon-refresh" circle
                                           @click="doRefreshMetas">
                                </el-button>
                            </el-row>
                        </el-col>
                    </el-row>
                    <el-row>
                        <el-input clearable v-model="form.procedureId" placeholder="选中过程"></el-input>
                    </el-row>
                    <el-row>
                        <el-input clearable v-model="metas.filterMeta" placeholder="过滤过程"></el-input>
                    </el-row>
                    <recycle-scroller :items="computeFilterMetas"
                                      class="scroller"
                                      :item-size="32"
                                      key-field="name"
                                      v-slot="{ item }">
                        <el-row type="flex"
                                :class="'list-item '+(item==form.method?'checked-item':'')"
                                @click.native="onClickMetaItem(item)">
                            <el-col :span="12" style="border-right: solid 1px #777;">
                                <el-tooltip class="item" effect="dark" :content="item.name" placement="top-start">
                                    <span class="list-item-cell">{{item.name}}</span>
                                </el-tooltip>
                            </el-col>
                            <el-col :span="4" style="border-right: solid 1px #777;">
                                <el-tooltip class="item" effect="dark" :content="item.type" placement="top-start">
                                    <span class="list-item-cell">{{item.type}}</span>
                                </el-tooltip>
                            </el-col>
                            <el-col :span="8">
                                <el-tooltip class="item" effect="dark" :content="(item.arguments||[]).filter(e=>e!='id' && e!='return').join(',')" placement="top-start">
                                    <span class="list-item-cell" style="display: inline-block;width: 100%;height: 100%;">
                                        <el-tag type="success" class="table-cell-hidden" @click.stop="onViewText(item,'过程详情','javascript')">更多</el-tag>
                                        {{(item.arguments||[]).filter(e=>e!='id' && e!='return').join(',')}}
                                    </span>
                                </el-tooltip>
                            </el-col>
                        </el-row>
                    </recycle-scroller>
                </el-card>
                <el-card v-show="form.enableEvalScript" shadow="never">
                    <el-row type="flex">
                        <el-col :span="12">
                            <el-row>
                                <el-switch
                                        v-model="form.enableEvalScript"
                                        active-text="脚本"
                                        inactive-text="过程">
                                </el-switch>
                            </el-row>
                        </el-col>
                        <el-col :span="12">
                            <el-row type="flex" justify="end">
                                <el-select  clearable filterable v-model="form.lang"  placeholder="脚本类型" @change="onEvalLangChange">
                                    <el-option
                                            v-for="item in metas.evalLangList"
                                            :key="item.value"
                                            :label="item.label"
                                            :value="item.value">
                                    </el-option>
                                </el-select>
                            </el-row>
                        </el-col>
                    </el-row>
                    <el-row>
                        <el-divider></el-divider>
                        <textarea ref="refEvalScriptEditor"></textarea>
                    </el-row>
                </el-card>
            </el-col>
            <el-col :span="8">
                <el-card shadow="never">
                    <el-row type="flex">
                        <el-col :span="16">
                            调度参数
                        </el-col>
                        <el-col :span="8">
                            <el-row type="flex" justify="end">
                                <el-button  size="medium"
                                           icon="el-icon-reading" circle
                                           @click="onFillParams">
                                </el-button>
                            </el-row>
                        </el-col>
                    </el-row>
                    <el-divider></el-divider>
                    <textarea ref="refEditor"></textarea>
                </el-card>
            </el-col>
        </el-row>
    </el-card>

    <el-row>
        <el-form inline label-position="left" label-width="120px">
            <el-row>
                <el-button size="medium" @click="doResetData">重置</el-button>
                <el-divider direction="vertical"></el-divider>
                <el-form-item label="最大等待秒数">
                    <el-input-number v-model="form.waitForSeconds" :min="0" :max="500"></el-input-number>
                </el-form-item>
                <el-form-item>
                    <el-popover
                            placement="top-start"
                            width="200"
                            trigger="hover">
                            <span>
                                一个XProc4j过程会使用一个默认的数据源进行执行<br/>
                                如果默认的数据源不满足运行要求<br/>
                                则可以在此处选择以更改 datasourcesMapping 以进行数据源映射
                            </span>
                        <el-select slot="reference"  clearable filterable v-model="form.datasource" placeholder="数据源">
                            <el-option
                                    v-for="item in metas.datasources"
                                    :key="item"
                                    :label="item"
                                    :value="item">
                            </el-option>
                        </el-select>
                    </el-popover>
                    <el-button v-loading="metas.datasourcesLoading" size="medium"
                               icon="el-icon-refresh" circle
                               @click="doRefreshDatasources">
                    </el-button>
                </el-form-item>
                <el-form-item >
                    <el-popover
                            placement="top-start"
                            width="200"
                            trigger="hover">
                            <span>
                                主机锁定，在多实例部署的环境中，可以用来确定需要执行的操作的主机<br/>
                                如果不是需要执行的主机接收到了请求，将会立即失败，不会执行操作<br/>
                                这时候重新发起请求进行重试操作，多几次就能够在需要执行的主机上执行！
                            </span>
                        <el-checkbox slot="reference" v-model="form.useHostId">主机锁定</el-checkbox>
                    </el-popover>
                    <el-select  clearable filterable v-model="form.hostId" :disabled="!form.useHostId" placeholder="主机锁定">
                        <el-option
                                v-for="item in metas.hostIdList"
                                :key="item"
                                :label="item"
                                :value="item">
                        </el-option>
                    </el-select>
                    <el-popover
                            placement="top-start"
                            width="200"
                            trigger="hover">
                            <span>
                                在多实例部署的环境中，就需要通过反复刷新的方式，尽量的获取所有的实例列表<br/>
                                因此根据实际情况，请多次刷新来获取完整的实例列表
                            </span>
                        <el-button slot="reference" v-loading="metas.hostIdLoading" size="medium"
                                   icon="el-icon-refresh" circle
                                   @click="doRefreshHostId">
                        </el-button>
                    </el-popover>
                    <el-popover
                            placement="top-start"
                            width="200"
                            trigger="hover">
                            <span>
                                进行后端代理转发<br/>
                                如果后端进行的负载均衡策略不能保证稳定的轮询的情况下<br/>
                                比如主机粘连、Session粘连、非均匀负载的情况<br/>
                                这样直接通过后端代理转发的方式，将可以明确的转发到需要执行的机器上
                            </span>
                        <el-checkbox slot="reference" v-model="form.proxyHostId">代理转发</el-checkbox>
                    </el-popover>
                </el-form-item>
            </el-row>
            <el-row type="flex" justify="center">
                <el-form-item>
                    <el-checkbox v-model="form.async">异步执行</el-checkbox>
                    <el-button v-loading="metas.resultLoading" size="medium"
                               type="primary"
                               @click="onExecute">
                        执行
                    </el-button>
                </el-form-item>
            </el-row>
        </el-form>
    </el-row>
    <el-divider>操作结果</el-divider>
    <el-card shadow="never">
        <el-form inline label-position="left" label-width="100px">
            <el-form-item label="语言类型">
                <el-select  clearable filterable v-model="metas.resultLang"  placeholder="语言类型" @change="onResultLangChange">
                    <el-option
                            v-for="item in metas.langList"
                            :key="item.value"
                            :label="item.label"
                            :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>
        </el-form>
        <textarea ref="refResultEditor"></textarea>
    </el-card>

    <el-dialog
            :title="dialog.textViewer.title"
            :visible.sync="dialog.textViewer.show"
            width="80%">
        <el-card shadow="never">
            <el-form inline label-position="left" label-width="100px">
                <el-form-item label="语言类型">
                    <el-select  clearable filterable v-model="dialog.textViewer.lang"  placeholder="语言类型" @change="onTextViewerLangChange">
                        <el-option
                                v-for="item in metas.langList"
                                :key="item.value"
                                :label="item.label"
                                :value="item.value">
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <textarea ref="refTextViewerEditor"></textarea>
        </el-card>
    </el-dialog>
</div>
</body>
<script>
    Vue.use(VueVirtualScroller.default);
    window.app = new Vue({
        components: {},
        data() {
            return this.getDefaultData()
        },
        created() {
            this.initStoreData();
            this.initCompletionsRefreshInterval();
            this.initBroadcast();
        },
        mounted() {
            this.initEditor();
            this.initResultEditor();
            this.initEvalScriptEditor();
            this.initTextViewerEditor();
        },
        watch: {},
        computed: {
            computeFilterMetas() {
                let list = this.metas.metas || [];
                return list.filter(item => {
                    return (!this.metas.filterMeta || item.name.toLowerCase().indexOf(this.metas.filterMeta.toLowerCase()) >= 0);
                })
            }
        },
        methods: {
            getDefaultData() {
                return {
                    editor: null,
                    opsBroadcastChannel:null,
                    langEditors: {
                        resultEditor: null,
                        evalScriptEditor: null,
                        textViewerEditor: null,
                    },
                    completions: [],
                    storage: {},
                    metas: {
                        cert: '',
                        resultLoading: false,
                        resultLang: 'javascript',
                        resultText: '',
                        filterMeta: '',
                        datasourcesLoading: false,
                        datasources: [],
                        metasLoading: false,
                        metas: [],
                        hostIdLoading: false,
                        hostIdList:[],
                        langList:[
                            {label: 'Text',value:'text'},
                            {label: 'Yaml',value:'yaml'},
                            {label: 'Json',value:'javascript'},
                            {label: 'SQL',value:'sql'},
                            {label: 'Shell',value:'shell'},
                            {label: 'Xml',value:'xml'},
                            {label: 'Html',value:'htmlmixed'},
                            {label: 'Markdown',value:'markdown'},
                            {label: 'Groovy',value:'groovy'},
                            {label: 'Nginx',value:'nginx'},
                            {label: 'Python',value:'python'},
                        ],
                        evalLangList:[
                            {label: 'XProc4J',value:'xproc4j',editorLang: 'xml'},
                            {label: 'Groovy',value:'groovy',editorLang: 'groovy'},
                            {label: 'TinyScript',value:'tinyscript',editorLang:'javascript'},
                            {label: 'JavaScript',value:'javascript',editorLang: 'javascript'},
                            {label: 'Ognl',value:'ognl',editorLang: 'javascript'},
                            {label: 'Java',value:'java',editorLang: 'groovy'},
                        ],
                    },
                    drawer: {

                    },
                    dialog: {
                        textViewer: {
                            show: false,
                            title: '文本浏览',
                            text: '',
                            lang: 'text'
                        },
                    },
                    form: {
                        useHostId: false,
                        hostId: '',
                        proxyHostId: false,
                        enableEvalScript: false,
                        datasource: '',
                        procedureId: '',
                        params: JSON.stringify({
                            global: {},
                            datasourcesMapping: {
                                primary: null,
                            },
                        },null,'    '),
                        lang: 'xproc4j',
                        script: '',
                        async: false,
                        waitForSeconds: 60,
                    }
                }
            },
            initBroadcast(){
                this.opsBroadcastChannel = new BroadcastChannel('ops_station_broadcast');

                setInterval(()=>{
                    this.opsBroadcastChannel.postMessage({
                        type: 'cert',
                        data: this.metas.cert
                    });
                },3000)


                this.opsBroadcastChannel.onmessage = (event) => {
                    let data=event.data;
                    if(data.type=='cert'){
                        if(!this.metas.cert || this.metas.cert==''){
                            this.metas.cert=data.data;
                        }
                    }
                };

            },
            loadData() {
                let content = localStorage.getItem('ops:xproc4j:data');
                if (!content) {
                    return
                }
                content = content.trim();
                if (content.length == 0) {
                    return;
                }
                try {
                    let obj = JSON.parse(content);
                    Object.keys(obj).forEach(k => {
                        this.$data[k] = obj[k];
                    });
                } catch (e) {

                }
            },
            storeData() {
                try {
                    let data = {...this.$data};
                    data.editor = null;
                    data.opsBroadcastChannel=null;
                    data.langEditors={};
                    Object.keys(this.$data.langEditors).forEach(k=>{
                        data.langEditors[k]=null;
                    })
                    let json = JSON.stringify(data);
                    let obj = JSON.parse(json);
                    obj.metas.cert = '';
                    let content = JSON.stringify(obj);
                    localStorage.setItem('ops:xproc4j:data', content);
                } catch (e) {
                    // console.log(e)
                }
            },
            initCompletionsRefreshInterval() {
                let _this = this;

                function refresh() {
                    setTimeout(() => {
                        _this.collectCompletionItems()
                        refresh();
                    }, 3000);
                }

                refresh();
            },
            collectCompletionItems() {
                //console.log('begin collect completions ...')
                let items = [];
                let keywords = [
                    'global','datasourcesMapping','primary'
                ]
                if (keywords) {
                    items.push(...keywords);
                }

                let completions = [];
                items.forEach(item => {
                    if (!item) {
                        return;
                    }
                    item = item.trim();
                    if (item == '') {
                        return;
                    }
                    if (!completions.includes(item)) {
                        completions.push(item);
                    }
                })
                this.completions = items;
                //console.log('end collect completions .')
            },
            editorCompletionItemCollector(prefix){
                if(!prefix){
                    prefix='';
                }
                prefix=prefix.toLowerCase();
                let ret= [];
                let count=50;
                for (let i=0;i<this.completions.length;i++) {
                    let e=this.completions[i];
                    if(e && e.toLowerCase().indexOf(prefix)>=0){
                        ret.push(e);
                        count--;
                        if(count<=0){
                            break;
                        }
                    }
                }
                return ret;
            },
            initEditor() {
                let _this = this;

                function asyncHint(editor, callback, options) {
                    let cur = editor.getCursor();
                    let token = editor.getTokenAt(cur);
                    let prefix = token.string;

                    let items = _this.editorCompletionItemCollector(prefix) || []
                    let result = []
                    if (result && result.list) {
                        items = [...items, ...result.list]
                    }
                    callback({
                        list: items,
                        from: CodeMirror.Pos(cur.line, token.start),
                        to: CodeMirror.Pos(cur.line, token.end)
                    });
                }

                asyncHint.async = true;
                asyncHint.supportsSelection = true;

                let dom = this.$refs.refEditor;
                this.editor = CodeMirror.fromTextArea(dom, {  // 标识到textarea
                    value: "",  // 文本域默认显示的文本
                    mode: "javascript",  // 模式
                    theme: "idea",  // CSS样式选择
                    indentUnit: 2,  // 缩进单位，默认2
                    smartIndent: true,  // 是否智能缩进
                    tabSize: 4,  // Tab缩进，默认4
                    readOnly: false,  // 是否只读，默认false
                    showCursorWhenSelecting: true,
                    hintOptions: {
                        completeSingle: false,
                        hint: asyncHint,
                    },
                    lineNumbers: true  // 是否显示行号
                    // .. 还有好多，翻译不完。需要的去看http://codemirror.net/doc/manual.html#config
                });
                this.editor.on("keypress", () => {
                    //编译器内容更改事件
                    this.editor.showHint();
                });
                this.editor.display.wrapper.style.height='340px';
                this.editor.setValue(this.form.params || '');
                this.editor.on('change', () => {
                    this.form.params = this.editor.getValue();
                });
            },
            initLangEditor(editorProp,editorRef,editorLang,afterCallback,optionCallback){
                let bts=new Date().getTime()
                let initEditorTask=()=> {
                    if (this.langEditors[editorProp]) {
                        try {
                            this.langEditors[editorProp].toTextArea()
                        } catch (e) {

                        }
                    }
                    this.langEditors[editorProp] = null;

                    let dom = this.$refs[editorRef];
                    if(!dom){
                        let cts=new Date().getTime();
                        if(cts-bts<3000){
                            setTimeout(initEditorTask,30);
                        }
                        return
                    }
                    if(!optionCallback){
                        optionCallback=function(option){
                            return option
                        }
                    }
                    this.langEditors[editorProp] = CodeMirror.fromTextArea(dom, optionCallback({  // 标识到textarea
                        value: "",  // 文本域默认显示的文本
                        mode: editorLang || '',  // 模式
                        theme: "idea",  // CSS样式选择
                        indentUnit: 2,  // 缩进单位，默认2
                        smartIndent: true,  // 是否智能缩进
                        tabSize: 4,  // Tab缩进，默认4
                        readOnly: false,  // 是否只读，默认false
                        showCursorWhenSelecting: true,
                        hintOptions: {
                            completeSingle: false,
                        },
                        lineNumbers: true  // 是否显示行号
                        // .. 还有好多，翻译不完。需要的去看http://codemirror.net/doc/manual.html#config
                    }));
                    this.langEditors[editorProp].on("keypress", () => {
                        //编译器内容更改事件
                        this.langEditors[editorProp].showHint();
                    });
                    if (afterCallback) {
                        afterCallback(this.langEditors[editorProp], dom)
                    }
                }

                initEditorTask()
            },
            initResultEditor() {
                this.initLangEditor('resultEditor','refResultEditor',this.metas.resultLang,(editor,dom)=>{
                    editor.setValue(this.metas.resultText || '');
                    editor.on('change', () => {
                        this.metas.resultText = editor.getValue();
                    });
                })

            },
            onResultLangChange(){
                this.initResultEditor();
            },
            initEvalScriptEditor(){
                let _this=this;
                let lang='xml'
                for (let i = 0; i < this.metas.evalLangList; i++) {
                    let item=this.metas.evalLangList[i];
                    if(item.value==this.form.lang){
                        lang=item.editorLang;
                        break;
                    }
                }
                this.initLangEditor('evalScriptEditor','refEvalScriptEditor',lang,(editor,dom)=>{
                    editor.display.wrapper.style.height='320px';
                    editor.setValue(this.form.script || '');
                    editor.on('change', () => {
                        this.form.script = editor.getValue();
                    });

                },(option)=>{
                    function completionItemCollector(prefix){
                        let completions=[]
                        if(lang=='xml'){
                            // tags
                            completions.push(...[
                                "procedure",
                                "log-debug",
                                "log-info",
                                "log-warn",
                                "log-error",
                                "debugger",
                                "lang-printf",
                                "lang-println",
                                "lang-string",
                                "lang-render",
                                "lang-string-join",
                                "lang-set",
                                "lang-format-date",
                                "lang-format",
                                "lang-invoke",
                                "lang-shell",
                                "lang-file-exists",
                                "lang-file-mkdirs",
                                "lang-file-delete",
                                "lang-file-list",
                                "lang-file-tree",
                                "lang-file-read-text",
                                "lang-file-write-text",
                                "lang-body",
                                "lang-eval",
                                "lang-eval-java",
                                "lang-java-import",
                                "lang-java-member",
                                "lang-java-body",
                                "lang-eval-groovy",
                                "lang-eval-javascript",
                                "lang-eval-js",
                                "lang-eval-tinyscript",
                                "lang-eval-ts",
                                "lang-if",
                                "lang-choose",
                                "lang-when",
                                "lang-otherwise",
                                "lang-while",
                                "lang-foreach",
                                "lang-fori",
                                "lang-break",
                                "lang-continue",
                                "lang-try",
                                "lang-catch",
                                "lang-finally",
                                "lang-retry",
                                "lang-throw",
                                "lang-async-all",
                                "lang-async",
                                "lang-synchronized",
                                "lang-lock",
                                "lang-latch",
                                "lang-latch-await",
                                "lang-latch-down",
                                "lang-sleep",
                                "lang-new-params",
                                "procedure-call",
                                "function-call",
                                "java-call",
                                "lang-return",
                                "script-include",
                                "script-segment",
                                "lang-thread-pool",
                                "lang-thread-pool-submit",
                                "lang-thread-pool-shutdown",
                                "sql-cursor",
                                "sql-etl",
                                "etl-extra",
                                "etl-transform",
                                "etl-load",
                                "etl-before",
                                "etl-after",
                                "sql-query-list",
                                "sql-query-object",
                                "sql-query-row",
                                "sql-update",
                                "sql-query-columns",
                                "sql-dialect",
                                "sql-scope",
                                "sql-script",
                                "sql-trans-begin",
                                "sql-trans-commit",
                                "sql-trans-none",
                                "sql-trans-rollback",
                                "sql-transactional",
                                "sql-runner",
                                "context-convert-method-class",
                                "context-invoke-method-class",
                                "context-load-package",
                                "event-send",
                                "event-publish",
                                "lang-ai",
                            ])
                            // attrs
                            completions.push(...[
                                "id",
                                "value",
                                "result",
                                "radix",
                                "pattern",
                                "await",
                                "delay",
                                "time-unit",
                                "test",
                                "collection",
                                "item",
                                "first",
                                "index",
                                "begin",
                                "end",
                                "incr",
                                "method",
                                "target",
                                "arg",
                                "timeout",
                                "name",
                                "count",
                                "tag",
                                "separator",
                                "type",
                                "e",
                                "cause",
                                "force",
                                "pool",
                                "jdbc-type",
                                "refid",
                                "params",
                                "params-share",
                                "batch-size",
                                "accept-batch",
                                "use-cursor",
                                "sync",
                                "async",
                                "databases",
                                "script",
                                "datasource",
                                "result-type",
                                "offset",
                                "limit",
                                "limited",
                                "propagation",
                                "isolation",
                                "read-only",
                                "rollback-for",
                                "no-rollback-for",
                                "datasources",
                                "read-batch-size",
                                "write-batch-size",
                                "before-truncate",
                                "commit-size",
                                "exclude",
                                "include",
                                "external",
                                "source",
                                "table",
                                "jump-error",
                                "full-send",
                                "package",
                                "class",
                                "run-as-file",
                                "workdir",
                                "envp",
                                "file",
                                "charset",
                                "content",
                                "event-type",
                            ])

                        }

                        // features
                        completions.push(...[
                            "in",
                            "out",
                            "int",
                            "double",
                            "float",
                            "string",
                            "long",
                            "short",
                            "char",
                            "byte",
                            "boolean",
                            "null",
                            "date",
                            "render",
                            "trim",
                            "align",
                            "body-text",
                            "body-xml",
                            "location-file",
                            "location-line",
                            "location-tag",
                            "location",
                            "spacing-left",
                            "spacing-right",
                            "spacing",
                            "lower",
                            "upper",
                            "hashcode",
                            "visit",
                            "eval",
                            "test",
                            "context",
                            "executor",
                            "node",
                            "eval-java",
                            "eval-js",
                            "eval-tinyscript",
                            "eval-ts",
                            "eval-groovy",
                            "class",
                            "not",
                            "dialect",
                            "is-null",
                            "is-not-null",
                            "is-empty",
                            "is-not-empty",
                            "date-now",
                            "uuid",
                            "current-time-millis",
                            "snow-uid",
                            "new-map",
                            "new-list",
                            "new-set",
                            "cause-first",
                            "cause-last",
                            "cause-raw",
                            "cause-root",
                        ])
                        // params
                        completions.push(...[
                            "stack_lock",
                            "context",
                            "env",
                            "beans",
                            "datasources",
                            "datasourcesMapping",
                            "global",
                            "trace",
                            "location",
                            "file",
                            "line",
                            "tag",
                            "errmsg",
                            "node",
                            "stack",
                            "calls",
                            "errors",
                            "error",
                            "last_sql",
                            "last_sql_effect_count",
                            "last_sql_use_time",
                            "executor",
                            "lru",
                            "executorLru",
                            "staticLru",
                            "connections",
                            "primary",
                            "return",
                            "metas",
                        ])

                        return completions.filter(e=>e && e!='').filter(e=>e.toLowerCase().indexOf(prefix.toLowerCase())>=0)
                    }
                    function asyncHint(editor, callback, options) {
                        let cur = editor.getCursor();
                        let token = editor.getTokenAt(cur);
                        let prefix = token.string;

                        let items = completionItemCollector(prefix) || []
                        let result = []
                        if (result && result.list) {
                            items = [...items, ...result.list]
                        }
                        callback({
                            list: items,
                            from: CodeMirror.Pos(cur.line, token.start),
                            to: CodeMirror.Pos(cur.line, token.end)
                        });
                    }

                    asyncHint.async = true;
                    asyncHint.supportsSelection = true;

                    option.hintOptions= {
                        completeSingle: false,
                        hint: asyncHint,
                    }

                    return option
                })
            },
            onEvalLangChange(){
              setTimeout(()=>{
                  this.initEvalScriptEditor()
              },200)
            },
            initTextViewerEditor(){
                this.initLangEditor('textViewerEditor','refTextViewerEditor',this.dialog.textViewer.lang,(editor,dom)=>{
                    editor.display.wrapper.style.height=Math.max(Math.round(window.innerHeight*0.85-270),320)+'px';
                    editor.setValue(this.dialog.textViewer.text || '');
                    editor.on('change', () => {
                        this.dialog.textViewer.text = editor.getValue();
                    });

                })
            },
            onTextViewerLangChange(){
                this.initTextViewerEditor()
            },
            onViewText(obj, title,lang) {
                if (title && title.length > 0) {
                    this.dialog.textViewer.title = title;
                } else {
                    this.dialog.textViewer.title = '文本浏览';
                }
                let text = ''
                if (typeof obj == 'string') {
                    text = obj;
                } else {
                    text = JSON.stringify(obj, null, '    ');
                }
                this.dialog.textViewer.lang=lang || 'text';
                this.dialog.textViewer.text = text;
                this.dialog.textViewer.show = true;
                setTimeout(()=>{
                    this.initTextViewerEditor()
                },200)
            },
            initStoreData() {
                let reset = new URL(window.location.href).searchParams.get('reset');
                if (reset != 'true') {
                    this.loadData();
                }
                setInterval(() => {
                    this.storeData();
                }, 1000);
            },
            doResetData() {
                let newData = this.getDefaultData();
                Object.keys(newData).forEach(k => {
                    this.$data[k] = newData[k];
                })
            },
            getTransfer() {
                let cert = this.metas.cert;
                if (!cert || cert.length == 0) {
                    cert = '';
                }
                cert = cert.trim();
                if (!cert || cert.length == 0) {
                    throw new Error('请先填写连接证书')
                }
                let ex = null;
                for (let i = 0; i < 3; i++) {
                    try {
                        let keyPair = OpsSecureHelper.deserializeKeyPair(cert)
                        return new OpsSecureTransfer(keyPair)
                    } catch (e) {
                        ex = e;
                    }
                }
                if (!ex) {
                    ex = new Error('init transfer error')
                }
                throw e;
            },
            evalWorker(){
                if (!window.worker) {
                    window.worker = new Worker(URL.createObjectURL(new Blob([`
                        self.onmessage = function(e) {
                            try {
                                // 使用 Function 构造函数替代 eval，避免闭包污染
                                const func = new Function(e.data);
                                const result = func();
                                postMessage({ success: true, data: result });
                            } catch (err) {
                                postMessage({ success: false, error: err.toString() });
                            }
                        };
                    `], {type: 'text/javascript'})));
                }
                return window.worker;
            },
            eval(code){
                return new Promise((resolve, reject)=>{
                    const worker = this.evalWorker();

                    worker.postMessage(code); // 发送代码到 Worker

                    worker.onmessage = function(e) {
                        const { success, data, error } = e.data;
                        if (success) {
                            resolve(data)
                        } else {
                            reject(error);
                        }
                    };
                })
            },
            messageError(msg,limit){
                window._lastError=msg;
                if(limit && limit>=0) {
                    if (msg && msg.length > limit) {
                        msg = msg.substring(0, limit) + '...'
                    }
                }
                this.$message.error(msg)
            },
            onCertChange() {
                this.doRefreshMetas();
                this.doRefreshDatasources();
                this.doRefreshHostId();
            },
            assignHostId(req){
                if(this.form.useHostId){
                    req.hostId=this.form.hostId;
                    if(!req.hostId || req.hostId==''){
                        throw new Error('请选择锁定的主机')
                    }
                    req.proxyHostId=this.form.proxyHostId;
                }else{
                    req.hostId=null;
                }
                return req;
            },
            doRefreshHostId(){
                this.metas.hostIdLoading = true;
                try {
                    let req = {

                    }
                    let transfer = this.getTransfer();
                    this.$axios({
                        url: '/hostId',
                        method: 'post',
                        data: transfer.send(req)
                    }).then(res => {
                        if (res.data.code == 200) {
                            //console.log(res.data)
                            let resp = transfer.recv(res.data.data) || ''
                            //console.log(resp)
                            let list=[...this.metas.hostIdList];
                            if(resp && resp!='') {
                                if (!list.includes(resp)) {
                                    list.push(resp);
                                }
                            }
                            this.metas.hostIdList=list;
                        } else {
                            this.messageError(res.data.msg,300)
                        }
                    }).catch(err => {
                        this.messageError(err.errorMessage || err.message || '操作失败',300)
                    }).finally(() => {
                        this.metas.hostIdLoading = false;
                    })
                } catch (err) {
                    this.messageError(err.errorMessage || err.message || '操作失败',300)
                    this.metas.hostIdLoading = false;
                }
            },
            doRefreshMetas() {
                this.metas.metasLoading = true;
                try {
                    let req = this.assignHostId({

                    })
                    let transfer = this.getTransfer();
                    this.$axios({
                        url: '/metas',
                        method: 'post',
                        data: transfer.send(req)
                    }).then(res => {
                        if (res.data.code == 200) {
                            //console.log(res.data)
                            let resp = transfer.recv(res.data.data) || {}
                            //console.log(resp)
                            this.metas.metas = resp;
                        } else {
                            this.messageError(res.data.msg,300)
                        }
                    }).catch(err => {
                        this.messageError(err.errorMessage || err.message || '操作失败',300)
                    }).finally(() => {
                        this.metas.metasLoading = false;
                    })
                } catch (err) {
                    this.messageError(err.errorMessage || err.message || '操作失败',300)
                    this.metas.metasLoading = false;
                }
            },
            doRefreshDatasources() {
                this.metas.datasourcesLoading = true;
                try {
                    let req = this.assignHostId({

                    })
                    let transfer = this.getTransfer();
                    this.$axios({
                        url: '/datasources',
                        method: 'post',
                        data: transfer.send(req)
                    }).then(res => {
                        if (res.data.code == 200) {
                            //console.log(res.data)
                            let resp = transfer.recv(res.data.data) || {}
                            //console.log(resp)
                            this.metas.datasources = resp;
                        } else {
                            this.messageError(res.data.msg,300)
                        }
                    }).catch(err => {
                        this.messageError(err.errorMessage || err.message || '操作失败',300)
                    }).finally(() => {
                        this.metas.datasourcesLoading = false;
                    })
                } catch (err) {
                    this.messageError(err.errorMessage || err.message || '操作失败',300)
                    this.metas.datasourcesLoading = false;
                }
            },
            onExecute() {
                let tips='即将执行过程，是否继续？<br/>' + this.form.procedureId;
                if(this.form.enableEvalScript){
                    let script=this.form.script.trim();
                    if(script.length>30){
                        script=script.substring(0,30)+'...';
                    }
                    tips='即将执行脚本，是否继续？<br/>' + script
                }
                this.$confirm(tips, '操作提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning',
                    dangerouslyUseHTMLString: true
                }).then(() => {
                    this.doExecute();
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消执行'
                    });
                });
            },
            doExecute() {
                this.metas.resultLoading = true;
                try {
                    this.eval('return '+this.form.params)
                        .then(params=>{
                            let req = this.assignHostId({
                                procedureId: this.form.procedureId,
                                params: params,
                                async: this.form.async,
                                waitForSeconds: this.form.waitForSeconds,
                            });
                            let url='/call'
                            if(this.form.enableEvalScript){
                                req.procedureId=null;
                                req.lang=this.form.lang;
                                req.script=this.form.script

                                url='/eval-script'
                            }
                            let transfer = this.getTransfer();
                            this.$axios({
                                url: url,
                                method: 'post',
                                data: transfer.send(req)
                            }).then(res => {
                                if (res.data.code == 200) {
                                    //console.log(res.data)
                                    let resp = transfer.recv(res.data.data)
                                    // console.log(resp)
                                    resp=resp+'';
                                    try{
                                        resp=JSON.stringify(JSON.parse(resp),null,'    ')
                                    }catch (e){

                                    }
                                    this.metas.resultText = resp;
                                    this.metas.resultLang='javascript';

                                } else {
                                    this.metas.resultText = res.data.msg;
                                    this.metas.resultLang='text';
                                    this.messageError(res.data.msg,300)
                                }
                                setTimeout(()=>{
                                    this.initResultEditor();
                                },200)
                            }).catch(err => {
                                this.messageError(err.errorMessage || err.message || '操作失败',300)
                            }).finally(() => {
                                this.metas.resultLoading = false;
                            })
                        }).catch(err => {
                            this.messageError(err.errorMessage || err.message || '操作失败',300)
                        }).finally(() => {
                            this.metas.resultLoading = false;
                        })

                } catch (err) {
                    this.messageError(err.errorMessage || err.message || '操作失败',300)
                    this.metas.resultLoading = false;
                }
            },
            onClickMetaItem(item){
                this.form.procedureId=item.name;
            },
            onFillParams(){
                let params={
                    global: {},
                    datasourcesMapping:{
                        primary: null,
                    },
                }
                if(this.form.datasource && this.form.datasource!=''){
                    params.datasourcesMapping.primary=this.form.datasource;
                }
                if(this.form.procedureId && this.form.procedureId!=''){
                    let metas=this.metas.metas;
                    if(metas){
                        metas.forEach((item)=>{
                            if(item.name==this.form.procedureId){
                                let arguments=item.arguments;
                                if(arguments){
                                    arguments.forEach(key=>{
                                        if(key=='id' || key=='return'){
                                            return
                                        }
                                        params[key]=null;
                                    })
                                }
                            }
                        })
                    }
                }
                this.form.params=JSON.stringify(params,null,'    ');
                this.editor.setValue(this.form.params);
            }
        }
    })
    let defaultConfig = {
        baseURL: './',
        timeout: 10 * 60 * 1000,
        responseType: 'json'
    }
    let request = axios.create(defaultConfig)
    window.app.$axios = request
    window.app.$mount('#app')
</script>
<style>
    .cert-block {
        height: 32px;
        overflow: hidden;
    }

    .cert-block:hover {
        height: unset;
    }

    .list-item {
        margin-top: 3px;
        border-bottom: solid 1px #777;
    }

    .list-item:hover {
        background: lightskyblue;
    }

    .list-item-cell{
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        display: inherit;
    }


    .list-item-cell .table-cell-hidden {
        display: none;
    }

    .list-item-cell:hover .table-cell-hidden {
        display: unset;
    }

    .checked-item {
        background: darkorange;
    }

    .scroller {
        height: 290px
    }
</style>
</html>